<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f8f9fa; }
        .dashboard-title { font-size: 2em; font-weight: bold; letter-spacing: 1px; margin-bottom: 0.4em; }
        .card { margin-bottom: 2em; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="text-center mb-4">
            <div class="dashboard-title">DASHBOARD</div>
            <div>Welcome, <span id="username">User</span>!</div>
            <div id="datetime"></div>
            <div class="mt-3">
                <a href="editProfile.html" class="btn btn-primary me-2">Edit Profile</a>
                <a href="login.html" class="btn btn-secondary me-2">Log Out</a>
                <a href="bankDisplay.html" class="btn btn-info">Bank</a>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header"><b>Budget for This Month</b></div>
                    <div class="card-body" id="budgetSection">
                        <!-- Budget form or info will be injected by JS -->
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center g-4">
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header"><b>Monthly Expense Breakdown</b></div>
                    <div class="card-body">
                        <canvas id="expensePie" width="300" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header"><b>Saving Goal Progress</b></div>
                    <div class="card-body text-center">
                        <div id="goalTitle" class="fw-bold mb-2"></div>
                        <canvas id="savingPie" width="250" height="250"></canvas>
                        <div class="mt-3">
                            <button id="prevGoal" class="btn btn-outline-primary me-2">&#8592; Prev</button>
                            <button id="nextGoal" class="btn btn-outline-primary">Next &#8594;</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-5">
            <a href="expense.html" class="btn btn-success me-2">Expense Tracker</a>
            <a href="saving.html" class="btn btn-warning">Saving Goal</a>
        </div>
    </div>

    <script>
        // Dummy data for demonstration
        const username = "User";
        const budget_amount = 2000;
        const total_expense = 1200;
        const average_expense = 40;
        const edit_mode = false;
        const expense_types = ["Food", "Transport", "Bills"];
        const expense_totals = [600, 300, 300];
        const saving_goals = [
            { name: "Vacation", current: 500, target: 1000 },
            { name: "Emergency Fund", current: 300, target: 2000 }
        ];

        document.getElementById('username').innerText = username;

        // Budget Section
        function renderBudgetSection() {
            const section = document.getElementById('budgetSection');
            section.innerHTML = '';
            if (budget_amount === 0 || edit_mode) {
                section.innerHTML = `
                    <form id="budgetForm">
                        <div class="mb-3">
                            <label class="form-label">Enter your budget for this month (RM):</label>
                            <input type="number" class="form-control" name="budget_amount" min="1" required value="${budget_amount > 0 ? budget_amount : ''}">
                        </div>
                        <button type="submit" class="btn btn-primary">${budget_amount > 0 ? 'Update' : 'Save'}</button>
                        ${budget_amount > 0 ? '<button type="button" class="btn btn-secondary ms-2" id="cancelEdit">Cancel</button>' : ''}
                    </form>
                `;
                if (budget_amount > 0) {
                    document.getElementById('cancelEdit').onclick = () => location.reload();
                }
                document.getElementById('budgetForm').onsubmit = function(e) {
                    e.preventDefault();
                    alert('Budget saved! (Demo)');
                    location.reload();
                };
            } else {
                section.innerHTML = `
                    <p>Your budget for this month is: <b>RM${budget_amount.toFixed(2)}</b></p>
                    <p>Total expense for this month: RM${total_expense.toFixed(2)}</p>
                    <p>Average expense per day: RM${average_expense.toFixed(2)}</p>
                    ${total_expense > budget_amount
                        ? '<p class="text-danger fw-bold">You are over your budget!</p>'
                        : `<p>You have RM${(budget_amount-total_expense).toFixed(2)} left before reaching your budget.</p>`
                    }
                    <button type="button" class="btn btn-outline-primary" id="editBudgetBtn">Edit Budget</button>
                `;
                document.getElementById('editBudgetBtn').onclick = () => location.reload();
            }
        }
        renderBudgetSection();

        // Expense Pie Chart
        new Chart(document.getElementById('expensePie'), {
            type: 'pie',
            data: {
                labels: expense_types,
                datasets: [{
                    data: expense_totals,
                    backgroundColor: [
                        '#4e73df','#1cc88a','#36b9cc','#f6c23e','#e74a3b','#858796','#5a5c69'
                    ]
                }]
            }
        });

        // Saving Goal Pie Chart
        let currentGoalIdx = 0;
        const ctx = document.getElementById('savingPie').getContext('2d');
        let savingPieChart;

        function updateSavingPie(idx) {
            if (saving_goals.length === 0) {
                document.getElementById('goalTitle').innerText = "No Saving Goals";
                ctx.clearRect(0, 0, 250, 250);
                return;
            }
            const goal = saving_goals[idx];
            const saved = parseFloat(goal.current);
            const remain = Math.max(0, parseFloat(goal.target) - saved);
            document.getElementById('goalTitle').innerText = `${goal.name}: RM${saved} / RM${goal.target}`;
            const data = {
                labels: ['Saved', 'Not Yet Saved'],
                datasets: [{
                    data: [saved, remain],
                    backgroundColor: ['#1cc88a', '#e74a3b']
                }]
            };
            if (savingPieChart) {
                savingPieChart.data = data;
                savingPieChart.update();
            } else {
                savingPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: data,
                    options: {
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': RM' + context.parsed;
                                    }
                                }
                            },
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        }

        updateSavingPie(currentGoalIdx);

        document.getElementById('prevGoal').onclick = function() {
            if (saving_goals.length === 0) return;
            currentGoalIdx = (currentGoalIdx - 1 + saving_goals.length) % saving_goals.length;
            updateSavingPie(currentGoalIdx);
        };
        document.getElementById('nextGoal').onclick = function() {
            if (saving_goals.length === 0) return;
            currentGoalIdx = (currentGoalIdx + 1) % saving_goals.length;
            updateSavingPie(currentGoalIdx);
        };

        // Dummy datetime
        document.getElementById('datetime').innerText = new Date().toLocaleString();
    </script>
</body>
</html>
